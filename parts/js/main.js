// Generated by CoffeeScript 1.7.1
(function() {
  'use strict';
  var assert, backlog, cloud, data, draw, draw_hl_fade, draw_status, focus, links, sha256_bytes, tag, tags, throw_err, vis, _ref,
    __hasProp = {}.hasOwnProperty;

  throw_err = function(msg) {
    throw new Error(msg || 'Unspecified Error');
  };

  assert = function(condition, msg) {
    if (!condition) {
      return throw_err(msg || 'Assertion failed');
    }
  };

  sha256_bytes = function(str, count) {
    var c, hash, n, res, _i, _ref;
    if (count == null) {
      count = 1;
    }
    assert((typeof sjcl !== "undefined" && sjcl !== null ? sjcl.hash.sha256 : void 0) && count <= 4 * 8);
    _ref = [[], sjcl.hash.sha256.hash(str)], res = _ref[0], hash = _ref[1];
    while (hash) {
      c = hash.pop();
      for (n = _i = 0; _i <= 3; n = ++_i) {
        res.push(c & 0xff);
        count -= 1;
        if (count <= 0) {
          return res;
        }
        c >>>= 8;
      }
    }
    return assert(false);
  };

  for (tag in ffhome_tags) {
    if (!__hasProp.call(ffhome_tags, tag)) continue;
    data = ffhome_tags[tag];
    data.links.sort(function(a, b) {
      return b.frecency - a.frecency;
    });
  }

  tags = {
    indexed: ffhome_tags,
    sorted: ((function() {
      var _results;
      _results = [];
      for (tag in ffhome_tags) {
        if (!__hasProp.call(ffhome_tags, tag)) continue;
        data = ffhome_tags[tag];
        _results.push({
          tag: tag,
          value: data.value,
          links: data.links
        });
      }
      return _results;
    })()).sort(function(a, b) {
      return b.value - a.value;
    }),
    edges: {
      sorted: ffhome_tag_edges.sort(function(a, b) {
        return a[2] - b[2];
      }),
      indexed: (function(index) {
        var t1, t2, v, _i, _j, _len, _len1, _ref, _ref1, _ref2;
        for (_i = 0, _len = ffhome_tag_edges.length; _i < _len; _i++) {
          _ref = ffhome_tag_edges[_i], t1 = _ref[0], t2 = _ref[1], v = _ref[2];
          _ref1 = [[t1, t2], [t2, t1]];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            _ref2 = _ref1[_j], t1 = _ref2[0], t2 = _ref2[1];
            if (index[t1] == null) {
              index[t1] = {};
            }
            index[t1][t2] = v;
          }
        }
        return index;
      })({})
    },
    highlight: null
  };

  links = {
    indexed: (function(index) {
      var link, url, _i, _len, _ref;
      for (tag in ffhome_tags) {
        if (!__hasProp.call(ffhome_tags, tag)) continue;
        data = ffhome_tags[tag];
        _ref = data.links;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          link = _ref[_i];
          index[link.url] = index[link.url] || (function(link_copy) {
            var k, v;
            for (k in link) {
              if (!__hasProp.call(link, k)) continue;
              v = link[k];
              link_copy[k] = v;
            }
            return link_copy;
          })({
            tags: []
          });
          index[link.url].tags.push(tag);
        }
      }
      for (url in index) {
        if (!__hasProp.call(index, url)) continue;
        link = index[url];
        link.tags.sort();
      }
      return index;
    })({}),
    box: d3.select('#tag-links'),
    opacity: d3.scale.linear().range([0.7, 1])
  };

  vis = {
    color: (function(level) {
      return function(str) {
        var h, s, _ref;
        _ref = sha256_bytes(str, 2), h = _ref[0], s = _ref[1];
        return d3.hsl(h, s, level).toString();
      };
    })(0.3),
    box: d3.select('#vis'),
    data: null,
    status: d3.select('#vis-status div'),
    status_counter: 0,
    opacity: {
      highlight: 1,
      unrelated: 0.15,
      scale_ranges: {
        1: d3.scale.linear().range([0.3, 0.5])
      },
      scale_for: function(order, domain) {
        var a, b, scale;
        if (typeof domain === 'object') {
          domain = d3.values(domain);
        }
        if (typeof domain === 'array') {
          domain = d3.extent(domain);
        }
        assert(domain);
        scale = vis.opacity.scale_ranges[order].copy().domain(domain);
        a = domain[0], b = domain[1];
        if (a === b) {
          return (function(v) {
            return function(any) {
              return v;
            };
          })(scale.range()[1]);
        } else {
          return scale;
        }
      }
    }
  };

  _ref = [vis.box.node().clientWidth, vis.box.node().clientHeight], vis.w = _ref[0], vis.h = _ref[1];

  vis.svg = vis.box.select('svg').attr('width', vis.w).attr('height', vis.h);

  vis.bg = vis.svg.append('g').classed({
    background: true
  });

  vis.cloud = vis.svg.append('g').classed({
    'tag-cloud': true
  }).attr('transform', 'translate(' + [vis.w >> 1, vis.h >> 1] + ')');

  vis.graph = vis.svg.append('g').classed({
    'tag-graph': true
  });

  assert(vis.h > 100 && vis.w > 100, vis);

  vis.font_scale = vis.box.style('font-size');

  assert(vis.font_scale.match(/px$/), vis);

  vis.font_scale = parseInt(vis.font_scale);

  vis.font_scale = d3.scale.linear().range([vis.font_scale, vis.font_scale * 3]).domain([+tags.sorted[tags.sorted.length - 1].value, +tags.sorted[0].value]);

  draw_hl_fade = function(selection) {
    var edges, hl_check, opacity_scale;
    assert((selection != null) || vis.data);
    hl_check = function(d) {
      return !tags.highlight || d.tag === tags.highlight;
    };
    edges = tags.edges.indexed[tags.highlight] || {};
    opacity_scale = vis.opacity.scale_for(1, edges);
    if (selection == null) {
      selection = vis.cloud.selectAll('text').data(vis.data, function(d) {
        return d.tag;
      });
    }
    return selection.transition().duration(1000).style('opacity', function(d) {
      if (hl_check(d)) {
        return vis.opacity.highlight;
      }
      if (edges[d.tag] == null) {
        return vis.opacity.unrelated;
      }
      return opacity_scale(edges[d.tag]);
    });
  };

  draw = function(data, bounds) {
    var exit_group, exit_group_node, scale, text, text_transition;
    scale = bounds ? Math.min(vis.w / Math.abs(bounds[0].x - vis.w / 2), vis.w / Math.abs(bounds[1].x - vis.w / 2), vis.h / Math.abs(bounds[0].y - vis.h / 2), vis.h / Math.abs(bounds[1].y - vis.h / 2)) / 2 : 1;
    vis.data = data;
    vis.status_counter = 0;
    text = vis.cloud.selectAll('text').data(data, function(d) {
      return d.tag;
    });
    text_transition = text.transition().duration(1000).attr('transform', function(d) {
      return 'translate(' + [d.x, d.y] + ')rotate(' + d.rotate + ')';
    }).style('font-size', function(d) {
      return d.size + 'px';
    });
    draw_hl_fade(text_transition);
    text_transition = text.enter().append('text').attr('text-anchor', 'middle').attr('transform', function(d) {
      return 'translate(' + [d.x, d.y] + ')rotate(' + d.rotate + ')';
    }).style('font-size', function(d) {
      return d.size + 'px';
    }).on('click', function(d) {
      return focus(d);
    }).style('opacity', 1e-6);
    draw_hl_fade(text_transition);
    text.style('font-family', function(d) {
      return d.font;
    }).style('fill', function(d) {
      return vis.color(d.tag);
    }).attr('title', function(d) {
      return d.tag;
    }).text(function(d) {
      return d.tag;
    });
    exit_group = vis.bg.append('g').attr('transform', vis.cloud.attr('transform'));
    exit_group_node = exit_group.node();
    text.exit().each(function() {
      return exit_group_node.appendChild(this);
    });
    exit_group.transition().duration(1000).style('opacity', 1e-6).remove();
    return vis.cloud.transition().delay(250).duration(750).attr('transform', 'translate(' + [vis.w >> 1, vis.h >> 1] + ')scale(' + scale + ')');
  };

  draw_status = function() {
    vis.status_counter += 1;
    return vis.status.style('width', ((vis.status_counter / tags.sorted.length) * 100) + '%');
  };

  cloud = d3.layout.cloud().size([vis.w, vis.h]).spiral('archimedean').font('Impact').fontSize(function(d) {
    return vis.font_scale(d.value);
  }).timeInterval(Infinity).words(tags.sorted).text(function(d) {
    return d.tag;
  }).on('word', draw_status).on('end', draw).start();

  d3.select('#vis-shuffle').on('click', function(d) {
    tags.highlight = null;
    cloud.stop().start();
    return links.box.style('display', 'none');
  });

  focus = function(d) {
    var data_fext, frecency_scale, opacity, text;
    tags.highlight = d.tag;
    draw_hl_fade();
    data = tags.indexed[tags.highlight].links;
    data_fext = d3.extent(data, function(d) {
      return d.frecency;
    });
    data_fext[0] -= 0.1;
    opacity = links.opacity.copy().domain(data_fext);
    frecency_scale = d3.scale.linear().range([0, 100]).domain(data_fext);
    text = links.box.select('ul').selectAll('li').data(data, function(d, i) {
      return d.url;
    });
    text.enter().append('li').append('a').attr('href', function(d) {
      return d.url;
    }).attr('title', function(d) {
      var frec_percent, tag_list;
      frec_percent = Math.round(frecency_scale(d.frecency), 0);
      tag_list = links.indexed[d.url].tags.join(', ');
      return "frecency index: " + d.frecency + " (" + frec_percent + "% linear)\ntags: " + tag_list;
    }).text(function(d) {
      return d.title || d.url;
    });
    text.exit().remove();
    text.style('opacity', function(d) {
      return opacity(d.frecency);
    }).order();
    return links.box.style('display', 'block');
  };

  if ((typeof ffhome_links !== "undefined" && ffhome_links !== null) && ffhome_links.length) {
    backlog = d3.select('#backlog');
    backlog.select('ul').selectAll('li').data(ffhome_links).enter().append('li').append('a').attr('href', function(d) {
      return d.url;
    }).text(function(d) {
      return d.title || d.url;
    });
    backlog.style('display', 'block');
  }

}).call(this);
